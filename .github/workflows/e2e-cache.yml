name: Build E2E Cache

on:
  workflow_dispatch:

jobs:
  cache_build:
    name: 'Check and build E2E test caches'
    runs-on: ubuntu-latest
    timeout-minutes: 60
 
    steps:
      - name: Checkout requirements and manifests
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            package.json
            package-lock.json
            test/e2e/package.json
            test/e2e/package-lock.json
            backend/requirements.txt
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get cache key names
        id: key_names
        run: |
           echo "venv_key=e2e-venv-${{ hashFiles('./backend/requirements.txt') }}" >> $GITHUB_OUTPUT
           echo "node_key=e2e-node-${{ hashFiles('./package-lock.json') }}" >> $GITHUB_OUTPUT
           echo "pw_key=e2e-playwright-$(/bin/date -u "+%Y%m")" >> $GITHUB_OUTPUT

      # Backend cache check and refresh
      - name: Get venv cache status
        id: venv-cache-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches?key=${{ steps.key_names.outputs.venv_key }}")
          if echo "$RESULT" | grep -q '"total_count": 1'; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Check venv cache 
        if: steps.venv-cache-status.outputs.exists != 'true'
        uses: actions/cache@v4   
        id: e2e-venv
        with:
          path: ./backend/.venv
          key: ${{ steps.key_names.outputs.venv_key }}

      - name: Install Backend dependencies
        if: steps.venv-cache-status.outputs.exists != 'true'
        run: |
          python -m venv ./backend/.venv
          . ./backend/.venv/bin/activate
          pip install -r ./backend/requirements.txt

      # Frontend cache check and refresh
      - name: Get node_modules cache status
        id: node-cache-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches?key=${{ steps.key_names.outputs.node_key }}")
          if echo "$RESULT" | grep -q '"total_count": 1'; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
                
      - name: Check node_modules cache
        if: steps.node-cache-status.outputs.exists != 'true'
        uses: actions/cache@v4        
        id: node_modules-cache
        with:
          path: |
            ./node_modules
          key: ${{ steps.key_names.outputs.node_key }}
        
      - name: Install Frontend dependencies
        if: steps.node-cache-status.outputs.exists != 'true'
        run: npm install

      # Playwright cache check and refresh                
      - name: Get Playwright cache status
        id: playwright-cache-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULT=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/actions/caches?key=${{ steps.key_names.outputs.pw_key }}")
          if echo "$RESULT" | grep -q '"total_count": 1'; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Playwright cache
        if: steps.playwright-cache-status.outputs.exists != 'true'
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
            ./test/e2e/node_modules
          key: ${{ steps.key_names.outputs.pw_key }}

      - name: Install Playwright dependencies
        if: steps.playwright-cache-status.outputs.exists != 'true'
        run: |
           cd ./test/e2e
           npm ci
           npx playwright install --with-deps

